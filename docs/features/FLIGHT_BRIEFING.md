# 飞行简报功能 (Flight Briefing)

## 1. 功能概述

飞行简报功能提供类似真实航司的专业飞行简报生成服务，帮助飞行员快速获取航班所需的关键信息。该功能集成了模拟器数据（X-Plane/MSFS）、实时天气（METAR）、机场数据库以及智能计算算法，为用户提供一站式的飞行准备支持。

**版本**: v1.0.0 (2026-02-09)

## 2. 核心功能

### 2.1 航班信息管理
- **航班号**: 支持自动生成或自定义航班号（格式：2位代码+数字）。
- **机场信息**: 集成详细的机场数据（名称、坐标、海拔等）。
- **智能验证**: ICAO代码实时校验，确保机场存在且有效。

### 2.2 智能填报 (Auto-Fill)
当模拟器已连接时，系统可自动填充信息，简化操作：
- **触发条件**: 模拟器连接且首页已设置机场信息。
- **自动填充内容**:
  - **起飞机场**: 当前最近机场。
  - **到达机场**: 模拟器设置的目的地。
  - **备降机场**: 模拟器设置的备降机场。
- **状态提示**: 显示模拟器连接状态横幅（"✈️ 模拟器已连接"），并提供手动刷新按钮。

### 2.3 航路与性能计算
- **航路规划**: 支持自定义航路或直飞（DCT）。
- **距离计算**: 基于Haversine公式计算大圆距离。
- **时间估算**: 根据典型巡航速度（450kts）估算飞行时间。
- **巡航高度**: 支持自定义或默认高度设置。

### 2.4 智能重量数据集成
- **数据来源**:
  - **模拟器在线**: 从 `SimulatorProvider` 获取实时重量（总重、空重、载荷、燃油）。
  - **模拟器离线**: 使用默认估算值（ZFW 42000kg）。
- **计算逻辑**:
  - `起飞重量 (TOW)` = 模拟器总重量 或 (ZFW + 总燃油)
  - `零燃油重量 (ZFW)` = 模拟器空机重量 + 载荷 或 固定值
  - `落地重量 (LW)` = TOW - 航程燃油

### 2.5 燃油计划
提供完整的燃油预估：
- **航程燃油**: 基于距离计算 (2.5 kg/nm)。
- **备降燃油**: 预设200nm备降距离燃油。
- **储备燃油**: 30分钟续航储备 (1500 kg)。
- **滑行燃油**: 固定预设 (200 kg)。
- **额外燃油**: 航程燃油的5%。

### 2.6 实时天气与跑道推荐
- **天气源**: 实时获取NOAA METAR数据。
- **跑道选择**: 根据风向与跑道朝向计算最小顺风分量，自动推荐最佳起降跑道。
- **天气解析**: 显示风向风速、能见度、温露点、修压、云况。

### 2.7 历史记录与持久化
- **自动保存**: 生成简报后自动保存到本地存储（Shared Preferences）。
- **历史列表**: 保存最近50条记录，支持按时间查看。
- **数据恢复**: 应用重启后自动加载历史记录。
- **一键清除**: 支持清空所有历史数据。

## 3. 用户界面指南 (UI Guide)

界面采用左右分栏设计（桌面端），左侧为输入与控制，右侧为简报展示。

### 3.1 输入区域 (Left Panel)
#### 输入表单
- **航班号**: 自动大写，格式校验。
- **机场输入**:
  - `AirportSearchField` 组件提供智能搜索。
  - 输入2字符触发建议列表。
  - 实时校验ICAO代码有效性。
  - 回车键自动跳转下一项。
- **模拟器状态**: 顶部横幅显示模拟器连接状态及当前机场信息。

#### 历史记录
- 列表显示最近生成的简报（航班号、起降机场、时间）。
- 点击条目可快速在右侧加载详情。
- 选中项高亮显示，颜色适配深色/浅色主题。

### 3.2 简报展示区域 (Right Panel)
简报内容分为多个卡片展示：
1. **标题栏**: 显示航线信息，提供 **[📋 复制]** 按钮。
2. **航班信息 (✈️)**: 航班号、生成时间、机场全名。
3. **航路信息 (🗺️)**: 航路代码、高度、距离、时间。
4. **天气信息 (☁️)**: 起降机场的解码天气及METAR原文。
5. **跑道信息 (🛫)**: 推荐的起飞和落地跑道。
6. **燃油计划 (⛽)**: 各类燃油明细及总量。
7. **重量信息 (⚖️)**: ZFW, TOW, LW数据。

### 3.3 交互设计
- **输入反馈**: 错误输入框变红并显示提示文本。
- **复制功能**: 一键复制格式化文本到剪贴板。
- **响应式布局**: 小屏幕下自动切换为上下堆叠布局。

## 4. 技术架构与实现

### 4.1 架构分层
```
lib/
├── apps/
│   ├── models/
│   │   └── flight_briefing.dart          # 数据模型 (JSON序列化)
│   ├── services/
│   │   ├── briefing_service.dart         # 核心业务逻辑
│   │   └── briefing_storage_service.dart # 持久化存储服务
│   ├── providers/
│   │   └── briefing_provider.dart        # 状态管理
│   └── utils/
│       └── simulator_auto_fill_helper.dart # 自动填充工具类
└── pages/
    └── briefing/
        ├── briefing_page.dart            # 主页面
        └── widgets/
            ├── briefing_input_card.dart  # 输入卡片 (含验证逻辑)
            ├── briefing_display_card.dart # 展示卡片
            └── briefing_history_page.dart # 历史记录页
```

### 4.2 关键组件详解

#### SimulatorAutoFillHelper
- **功能**: 处理从 `SimulatorProvider` 获取数据并填充表单的逻辑。
- **方法**: `autoFillAirports()` 返回包含起降备机场的 `AutoFillResult`。

#### BriefingStorageService
- **功能**: 管理简报数据的本地持久化。
- **实现**: 使用 `shared_preferences` 存储JSON字符串列表。
- **策略**: 限制最大50条记录，新记录插入头部，超长自动截断。

#### AirportSearchField
- **功能**: 封装带搜索建议和验证功能的文本输入框。
- **验证**:
  - 正则限制 `[A-Z0-9]`.
  - 长度限制 4位.
  - 异步查询数据库验证ICAO有效性.

### 4.3 核心算法

#### 大圆距离 (Haversine)
```dart
distance = 2 * R * arcsin(sqrt(sin²(Δlat/2) + cos(lat1) * cos(lat2) * sin²(Δlon/2)))
```

#### 跑道选择
遍历机场所有跑道，计算其航向与METAR风向的差值，选择差值最小（顺风分量最小/逆风分量最大）的跑道。

## 5. 使用场景与流程

### 场景1：常规飞行准备
1. 打开简报页面。
2. 输入起飞机场 (ZBAA) 和 到达机场 (ZSPD)。
3. 等待天气加载，确认无误。
4. 点击生成，查看燃油和跑道建议。

### 场景2：模拟器联动
1. 启动模拟器并在机场就位。
2. 打开简报页面，系统提示"✈️ 模拟器已连接"。
3. 自动填充当前机场为起飞，计划目的地为到达。
4. 用户核对信息后一键生成。

### 场景3：查看历史
1. 点击"历史简报"或侧边栏历史记录。
2. 选择之前的飞行记录进行回顾或复飞。

## 6. 未来改进计划

- [ ] **高级天气**: 集成TAF预报和高空风数据。
- [ ] **航路优化**: 对接第三方航路API（如Simbrief）导入真实航路。
- [ ] **性能计算**: 根据机型提供更精确的起飞性能（V1/Vr/V2）计算。
- [ ] **导出格式**: 支持导出为PDF或图片格式。
- [ ] **多语言**: 完善英文界面的支持。
